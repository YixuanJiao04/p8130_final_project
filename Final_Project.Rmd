---
title: "Final Project"
author: "Yixuan Jiao, Landi Guo, Fengdi Zhang"
date: "2022-12-13"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r echo = FALSE, message = FALSE}
library(readxl)
library(tidyverse)
library(leaps)
library(glmnet)
library(corrplot)
library(caret)
library(MASS)
library(car)
library(interactions)
library(GGally)
library(patchwork)

select <- dplyr::select
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.width = 6, fig.height = 4)
set.seed(65)
```

```{r}
df_body_fat_raw <- 
  read_excel("body_density_data.xlsx") %>%
  select(-id,-bodyfat_siri,-body_density) %>%
  filter(bodyfat_brozek > 0)
#filter out high vif variable.
df_body_fat <-
  df_body_fat_raw %>%
  select(-weight,-chest,-hip,-thigh)
```
# Abstract

In this study, a multiple linear regression model is developed to predict body fat in men using scale and tape measurements. Candidate models are created using a dataset of 252 male subjects and are generated through the application of automatic procedures, criterion based procedures, and LASSO. Interactions between variables are also considered through two-way ANOVA. The final model chosen, based on its root mean square error, included age, height, neck circumference, abdomen circumference, forearm circumference, wrist circumference, and the interaction between neck and abdomen as predictors. These measurements are simple and widely available, making the model a useful tool for predicting body fat in a convenient manner.

# Introduction

Although fat is an essential part of our body and an important source of stored energy, excessive amounts of body fat is associated with type 2 diabetes, heart diseases, and stroke. More than 25 percent body fat is considered obese for adult male, while more than 32 percent body fat is considered obese for adult women. National data from the 2017-2020 National Health and Nutrition Examination Survey revealed that 41.9 percent of adults in the U.S. have obesity, and the adult obesity rate is over 35 percent in nineteen states. As obesity becomes one of the most common medical conditions in the U.S., it is important to find an accurate and easy way to find out one’s body fat. Unfortunately, body fat is not always straightforward to measure. We are given a dataset containing percentage of body fat, age, height, weight, and other body circumference measurements for 252 men. How can we possibly estimate body fat for men in a more convenient way? This project aims to build a multiple linear regression model using scale and tape measurements to predict body fat for men.

# Methods
## Exploratory Analysis
Exploratory analysis is conducted to check for patterns, distributions, and anomalies in the dataset. This dataset contains 252 observations which are all male, and 16 variables of interest. The first three variables are body fat measured in three different ways (Brozek’s, Siri’s, body density). The rest of the variables are age(years), weight(lbs), heights(inches), neck(neck circumference in cm), chest(chest circumference in cm), abdomen(abdomen circumference in cm), hip(hip circumference in cm), thigh(thigh circumference in cm), knee(knee circumference in cm), ankle(ankle circumference in cm), bicep(extended biceps circumference in cm), forearm(forearm circumference in cm), and wrist(wrist circumference in cm). These are simple measurements that can potentially be used to predict body fats.

In the rest of the analysis, percent body fat using Brozek’s equation is chosen as the outcome. Firstly, one entry with 0 body fat is removed from the dataset. Mean and range are summarized for the remaining observations(Table1). Then marginal distributions for each variable and pairwise relationship between each pair of variables are plotted(Fig1). The distributions for all variables are symmetric, therefore no transformation is needed. To confirm the normality of `bodyfat_brozek`, formal Shapiro’s test is conducted. The results of the test align with the histogram that `bodyfat_brozek` is normally distributed (Fig2). Pairwise scatterplot shows that all variables are linearly correlated with `bodyfat_brozek`. Additionally, there are many variables that are highly correlated with other variables, which require further investigation.

## Model Building

Variance inflation factor (VIF) for each variable is calculated for checking collinearity. Variables with VIF > 5 suggest that the coefficients might be misleading due to collinearity and high collinearity. `weight`, `hip`, `abdomen`, `chest`, and `thigh` have VIF > 5, but according to the p-values of the complete linear model, only `abdomen` is significant. Therefore, all these variables except `abdomen` are excluded. Re-calculate the VIFs and no more collinearity is found. Different model selection procedures are conducted on the remaining variables to generate candidate models. Procedures include automatic procedure (stepwise), criterion based procedure (Cp value and Adjusted R^2^), and LASSO. Interactions between main effects are considered by conducting a two-way ANOVA test. A 10-fold cross validation is used to compare the candidate models based on predictive ability and select a final “best” model. Diagnostic plots are also generated for comparison and final model selection.

# Result

The candidate model from stepwise regression includes `age`, `height`, `neck`, `abdomen`, `forearm`, and `wrist` as predictors to predict `bodyfat_brozek`. The candidate models from LASSO and criterion approach include all the same predictors as the model from stepwise regression, but also include an extra predictor `bicep`. Among the predictors in the candidate models, two-way ANOVA test(table?) reveals interaction between neck and abdomen has significant p-value = 0.000477 for model 1 and p-value = 0.000379 for model 2, suggesting it should be included in the model  under 5% significance. Therefore, the final candidate models are as following:
 Candidate model 1: `bodyfat_brozek` ~ `age` + `height` +  `neck` +  `abdomen` + `forearm` + `wrist` + `neck:abdomen`
Candidate model 2: `bodyfat_brozek` ~ `age` + `height` +  `neck` +  `abdomen` + `forearm` + `wrist` + `bicep` + `neck:abdomen`
The RMSE for 10-fold cross validation is 3.95 for model 1, and 3.98 for model 2. Therefore, model 1 has better predictivity than model 2. The adjusted R-squared for is 0.7385 for both model 1 and model 2, which means that `bicep` is not adding value to the model. Diagnosis plots(figure?) are also suggest that model 1 fits the underlying assumptions of linear regression better than model 2, because *add reasons*. In conclusion, the final model chosen is candidate model 1.

# Appendix

![](plots/bodyfat_brozek_pairs.png){width=65% height=65%}

```{r results = 'hide'}
#Shapiro test
shapiro.test(df_body_fat$bodyfat_brozek)
```

```{r}
#Histogram of distribution of bodyfat
df_body_fat_raw %>%
  ggplot(aes(x = bodyfat_brozek)) +
  geom_histogram() +
  theme_bw() +
  labs(title = "Distribution of Bodyfat Index Computed by Brozek equation",
       x = "Bodyfat Index Computed by Brozek equation",
       y = "Count",
       caption = "Fig2: Distribution of Bodyfat Index Computed by Brozek equation") -> fig2
```

```{r}
fig2
```

```{r}
#Raw VIF
mult.fit <- lm(bodyfat_brozek ~ .,data = df_body_fat_raw)

vif_values <- vif(mult.fit)
v_names <- str_to_title(names(vif_values))
vif_df <- 
  tibble(variable = v_names, vif = vif_values) %>%
  mutate(variable = fct_reorder(variable,vif))

ggplot(data = vif_df,aes(x = vif_values,y = variable)) +
  geom_bar(stat = 'identity') +
  geom_vline(xintercept = 5,colour = "red",linetype = "longdash") +
  theme_bw() +
  labs(x = "VIF Value",
       y = "Variable",
       title = "VIF Value of Predictors",
       caption = "Fig3a: VIF Value of Predictors")
```

```{r}
#VIF after deletion
mult.fit <- lm(bodyfat_brozek ~ .,data = df_body_fat)

vif_values <- vif(mult.fit)
v_names <- str_to_title(names(vif_values))
vif_df <- 
  tibble(variable = v_names, vif = vif_values) %>%
  mutate(variable = fct_reorder(variable,vif))

ggplot(data = vif_df,aes(x = vif_values,y = variable)) +
  geom_bar(stat = 'identity') +
  geom_vline(xintercept = 5,colour = "red",linetype = "longdash") +
  theme_bw() +
  labs(x = "VIF Value",
       y = "Variable",
       title = "VIF Value After Removing Highly Correlated Predictors",
       caption = "Fig3b: VIF Value After Removing Highly Correlated Predictors")
```


```{r}
#Stepwise model
stepwise.fit <- step(mult.fit, direction='both',trace = FALSE)
```


```{r}
#Criterion Figure
rs <- regsubsets(bodyfat_brozek ~ ., data = df_body_fat, nbest = 1) %>% summary()
par(mfrow = c(1,2))
plot(2:9, rs$cp, xlab="# of parameters", ylab="Cp Statistic")
title("Fig4a Cp Vs. Model Size")
abline(0,1)
plot(2:9, rs$adjr2, xlab="# of parameters", ylab="Adj R2")
title("Fig4b Adj R2 Vs. Model Size")
```

```{r}
lambda_seq <- 10^seq(-3, 0, by = .1)
cv_object <- cv.glmnet(as.matrix(df_body_fat[c(-1)]), df_body_fat$bodyfat_brozek,
lambda = lambda_seq, nfolds = 5) 
#cv_object would print out opitmal lambda wiht minimal mean CV error.
```

```{r}
#Lambda Figure
highlight_lamda <- 
  tibble(lambda = cv_object$lambda,
mean_cv_error = cv_object$cvm) %>%
  arrange(mean_cv_error)


tibble(lambda = cv_object$lambda,
mean_cv_error = cv_object$cvm) %>%
  ggplot(aes(x = lambda, y = mean_cv_error)) +
    geom_point() + 
    geom_point(data = highlight_lamda[1,], aes(x = lambda, y = mean_cv_error, color = 'red')) +
    labs(x = "Lambda",
         y = "Mean CV Error",
         title = "Lambda vs. Mean CV Error",
         caption = "Fig5 Plot for Selecting the Optimal Lambda") +
    theme_bw() -> fig5
fig5 + theme(legend.position = "none")
```

```{r}
#Lasso fit object
lasso_fit <- glmnet(as.matrix(df_body_fat[c(-1)]), df_body_fat$bodyfat_brozek, lambda = cv_object$lambda.min)
```

```{r}
final_mod1 <- update(stepwise.fit, . ~ . + neck*abdomen)
```

```{r}
#Diagnostic Plot of Final Model
par(mfrow = c(2,2))
plot(final_mod1)
text(x = 1, y = 1, "Total", cex = 1.5, col = "red")
```

```{r}
ggplot() +
  theme_minimal()
```


```{r}
#Descriptive Statistics table
df_body_fat %>%
  gtsummary::tbl_summary() %>%
  gtsummary::as_kable(format = "latex", caption = "Descriptive Statistics")
```

```{r}
#Stepwise model table
summary(stepwise.fit) %>% 
  broom::tidy() %>% 
  rename(Term = term,
         Estimate = estimate,
         `Standard Error` = std.error,
         `Test Statisitcs` = statistic,
         `P-value` = p.value) %>%
  knitr::kable(digits = c(5,2,2,2), "latex",caption = "Model Parameter for Stepwise Procedure")
```

```{r}
#Table for Cp and adjr2 value
criterion_mat <- as.matrix(df_body_fat)
cp <- leaps(x = criterion_mat[,c(-1)] , y = criterion_mat[,1], nbest = 1, method = "Cp")$Cp
adjr2 <- leaps(x = criterion_mat[,c(-1)] , y = criterion_mat[,1], nbest = 1, method = "adjr2")$adjr2
tibble(`Number of Parameter` = c(2:10),`Cp Value` = cp, `Adjusted R Square` = adjr2) %>%
  knitr::kable(digits = c(0,2,3),"latex",caption = "Criterion Score For Different Model Sizes")
```

```{r}
#LASSO model table
lasso_fit %>% broom::tidy() %>%
  select(term,estimate) %>%
  rename(Term = term,
         Esitmate = estimate) %>%
  knitr::kable(digits = 3, "latex",caption = "Model Parameter for Lasso Fit")
```

```{r}
#Validation for Candidate model 1 and 2
train = trainControl(method = "cv", number = 10)
model1_caret <- train(bodyfat_brozek ~ age + height + neck + abdomen + 
    forearm + bicep + wrist + neck:abdomen, data = df_body_fat,
trControl = train,
method = 'lm',
na.action = na.pass)
mod1 <- model1_caret$results[c(2,3,4)] %>% as_tibble()


train = trainControl(method = "cv", number = 10)
model2_caret = train(bodyfat_brozek ~ age + height + neck + abdomen + 
    forearm + wrist + neck:abdomen, data = df_body_fat,
trControl = train,
method = 'lm',
na.action = na.pass)
mod2 <- model2_caret$results[c(2,3,4)] %>% as_tibble()

bind_rows(mod1,mod2) %>%
  add_column(Model = c(1,2)) %>%
  select(Model,everything()) %>%
  rename(`R-square` = Rsquared) %>%
  knitr::kable(digits = 2, "latex",caption = "Validation Results for Candidate models")
```

```{r}
#Table of Two-way ANOVA Test for Model Candidate 1
aov(update(stepwise.fit, . ~ . + bicep + neck*abdomen)) %>%
  broom::tidy() %>%
  filter(term != "Residuals") %>%
  select(-df) %>%
  rename(Term = term,
         `P-value` = p.value,
         SSE = sumsq,
         MSE = meansq,
         `F-stats` = statistic) %>%
  dplyr::mutate_if(is.numeric, funs(as.character(signif(., 3)))) %>%
  knitr::kable(digits = 2, "latex",caption = "Two-way ANOVA Test for Model Candidate 1")
```

```{r}
#Table of Two-way ANOVA Test for Model Candidate 2
aov(update(stepwise.fit, . ~ . + bicep + neck*abdomen)) %>%
  broom::tidy() %>%
  filter(term != "Residuals") %>%
  select(-df) %>%
  rename(Term = term,
         `P-value` = p.value,
         SSE = sumsq,
         MSE = meansq,
         `F-stats` = statistic) %>%
  dplyr::mutate_if(is.numeric, funs(as.character(signif(., 3)))) %>%
  knitr::kable(digits = 2, "latex",caption = "Two-way ANOVA Test for Model Candidate 2")
```

```{r}
#Final Model Parameter
summary(final_mod1) %>%
  broom::tidy() %>% 
  rename(Term = term,
         Estimate = estimate,
         `Standard Error` = std.error,
         `Test Statisitcs` = statistic,
         `P-value` = p.value) %>%
  dplyr::mutate_if(is.numeric, funs(as.character(signif(., 3)))) %>%
  knitr::kable(digits = 2, "latex",caption = "Final Model Parameter")
```


---
title: "Final Project"
author: "Yixuan Jiao, Landi Guo, Fengdi Zhang"
date: "2022-12-13"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r echo = FALSE, message = FALSE}
library(readxl)
library(tidyverse)
library(leaps)
library(glmnet)
library(corrplot)
library(caret)
library(MASS)
library(car)
library(interactions)
library(GGally)

select <- dplyr::select
knitr::opts_chunk$set(echo = FALSE, message = FALSE,fig.width = 6, fig.height = 4)
set.seed(30)
```

```{r}
df_body_fat_raw <- 
  read_excel("body_density_data.xlsx") %>%
  select(-id,-bodyfat_siri,-body_density) %>%
  filter(bodyfat_brozek > 0)
#filter out high vif variable.
df_body_fat <-
  df_body_fat_raw %>%
  select(-weight,-chest,-hip,-thigh)
```
# Abstract


# Introduction

Although fat is an essential part of our body and an important source of stored energy, excessive amounts of body fat is associated with type 2 diabetes, heart diseases, and stroke. More than 25 percent body fat is considered obese for adult male, while more than 32 percent body fat is considered obese for adult women. National data from the 2017-2020 National Health and Nutrition Examination Survey revealed that 41.9 percent of adults in the U.S. have obesity, and the adult obesity rate is over 35 percent in nineteen states. As obesity becomes one of the most common medical conditions in the U.S., it is important to find an accurate and easy way to find out one’s body fat. Unfortunately, body fat is not always straightforward to measure. We are given a dataset containing percentage of body fat, age, height, weight, and other body circumference measurements for 252 men. How can we possibly estimate body fat for men in a more convenient way? This project aims to build a multiple linear regression model using scale and tape measurements to predict body fat for men.

# Methods
## Exploratory Analysis
Exploratory analysis is conducted to check for patterns, distributions, and anomalies in the dataset. This dataset contains 252 observations which are all male, and 16 variables of interest. The first three variables are body fat measured in three different ways (Brozek’s, Siri’s, body density). The rest of the variables are age(years), weight(lbs), heights(inches), neck(neck circumference in cm), chest(chest circumference in cm), abdomen(abdomen circumference in cm), hip(hip circumference in cm), thigh(thigh circumference in cm), knee(knee circumference in cm), ankle(ankle circumference in cm), bicep(extended biceps circumference in cm), forearm(forearm circumference in cm), and wrist(wrist circumference in cm). These are simple measurements that can potentially be used to predict body fats.

In the rest of the analysis, percent body fat using Brozek’s equation is chosen as the outcome. Firstly, one entry with 0 body fat is removed from the dataset. Mean and range are summarized for the remaining observations(Table1). Then marginal distributions for each variable and pairwise relationship between each pair of variables are plotted(Fig1). The distributions for all variables are symmetric, therefore no transformation is needed. To confirm the normality of `bodyfat_brozek`, formal Shapiro’s test is conducted. The results of the test align with the histogram that `bodyfat_brozek` is normally distributed (Fig2). Pairwise scatterplot shows that all variables are linearly correlated with `bodyfat_brozek`. Additionally, there are many variables that are highly correlated with other variables, which require further investigation.

## Model Building

Variance inflation factor (VIF) for each variable is calculated for checking collinearity. Variables with VIF > 5 suggest that the coefficients might be misleading due to collinearity and high collinearity. `weight`, `hip`, `abdomen`, `chest`, and `thigh` have VIF > 5, but according to the p-values of the complete linear model, only `abdomen` is significant. Therefore, all these variables except `abdomen` are excluded. Re-calculate the VIFs and no more collinearity is found. Different model selection procedures are conducted on the remaining variables to generate candidate models. Procedures include automatic procedure (stepwise), criterion based procedure (Cp value and Adjusted R square), and LASSO. Interactions between main effects are considered by conducting a two-way ANOVA test. A 10-fold cross validation is used to compare the candidate models based on predictive ability and select a final “best” model. Diagnostic plots are also generated for comparison and final model selection.

```{r}
#Histogram of distribution of bodyfat
df_body_fat_raw %>%
  ggplot(aes(x = bodyfat_brozek)) +
  geom_histogram() +
  theme_bw() +
  labs(title = "Distribution of Bodyfat Index Computed by Brozek equation",
       x = "Bodyfat Index Computed by Brozek equation",
       y = "Count",
       caption="Fig1: Distribution of Bodyfat Index Computed by Brozek equation")
```

```{r}
#Shapiro test
shapiro.test(df_body_fat$bodyfat_brozek)
```

```{r}
#Raw VIF
mult.fit <- lm(bodyfat_brozek ~ .,data = df_body_fat_raw)

vif_values <- vif(mult.fit)
v_names <- str_to_title (names(vif_values))
vif_df <- 
  tibble(variable = v_names, vif = vif_values) %>%
  mutate(variable = fct_reorder(variable,vif))

ggplot(data = vif_df,aes(y = variable, x = vif_values)) +
  geom_col() +
  geom_vline(xintercept = 5,colour="red",linetype = "longdash") +
  theme_bw() +
  labs(x = "VIF Value",
       y = "Variable",
       title = "VIF Value of Predictors")
```

```{r}
#VIF after deletion
mult.fit <- lm(bodyfat_brozek ~ .,data = df_body_fat)

vif_values <- vif(mult.fit)
v_names <- str_to_title (names(vif_values))
vif_df <- 
  tibble(variable = v_names, vif = vif_values) %>%
  mutate(variable = fct_reorder(variable,vif))

ggplot(data = vif_df,aes(y = variable, x = vif_values)) +
  geom_col() +
  geom_vline(xintercept = 5,colour="red",linetype = "longdash") +
  theme_bw() +
  labs(x = "VIF Value",
       y = "Variable",
       title = "VIF Value After Removing Highly Correlated Predictors")

```

```{r}
df_body_fat %>%
  gtsummary::tbl_summary() %>%
  gtsummary::as_kable(format = "latex", caption = "Discriptive Statistics")
```


```{r}
#Stepwise 
stepwise.fit <- step(mult.fit, direction='both',trace = FALSE)
summary(stepwise.fit) %>% 
  broom::tidy() %>% 
  rename(Term = term,
         Estimate = estimate,
         `Standard Error` = std.error,
         `Test Statisitcs` = statistic,
         `P-value` = p.value) %>%
  knitr::kable(digits = c(5,2,2,2), "latex",caption = "Parameter for Stepwise Model")
```

```{r}
mat <- as.matrix(df_body_fat)
leaps(x = mat[,c(-1)] , y = mat[,1], nbest = 1, method = "Cp")
```

```{r}
leaps(x = mat[,c(-1)] , y = mat[,1], nbest = 1, method = "adjr2")
```

```{r}
rs <- regsubsets(bodyfat_brozek ~ ., data = df_body_fat, nbest = 1) %>% summary()
```

```{r}
par(mfrow = c(1,2))
plot(2:9, rs$cp, xlab="# of parameters", ylab="Cp Statistic")
abline(0,1)
plot(2:9, rs$adjr2, xlab="# of parameters", ylab="Adj R2")
```

```{r}
lambda_seq <- 10^seq(-3, 0, by = .1)
cv_object <- cv.glmnet(as.matrix(df_body_fat[c(-1)]), df_body_fat$bodyfat_brozek,
lambda = lambda_seq, nfolds = 5)
cv_object
```

```{r}
highlight_lamda <- 
  tibble(lambda = cv_object$lambda,
mean_cv_error = cv_object$cvm) %>%
  arrange(mean_cv_error)


tibble(lambda = cv_object$lambda,
mean_cv_error = cv_object$cvm) %>%
ggplot(aes(x = lambda, y = mean_cv_error)) +
  geom_point() + 
  geom_point(data = highlight_lamda[1,], aes(x = lambda, y = mean_cv_error, color = 'red')) +
  labs(x = "Lambda",
       y = "Mean CV Error",
       title = "Lambda vs. Mean CV Error") +
  theme_bw()
  
```

```{r echo = TRUE}
lasso_fit <- glmnet(as.matrix(df_body_fat[c(-1)]), df_body_fat$bodyfat_brozek, lambda = cv_object$lambda.min)
coef(lasso_fit)
```

```{r}
mtemp <- lm(formula = bodyfat_brozek ~ age + height + neck + abdomen + 
    forearm + wrist, data = df_body_fat)
par(mfrow = c(2,2))
plot(mtemp)
```

```{r}
train = trainControl(method = "cv", number = 10)
model_caret = train(bodyfat_brozek ~ age + height + neck + abdomen + 
    forearm + wrist + neck:abdomen, data = df_body_fat,
trControl = train,
method = 'lm',
na.action = na.pass)
print(model_caret)
```

```{r}
inter_model <- lm(bodyfat_brozek ~ (age + height + neck + abdomen + forearm + wrist)^2, data = df_body_fat)
interact_plot(inter_model,pred = neck, modx = abdomen)
```

```{r}
interact_plot(update(stepwise.fit, . ~ . + neck*abdomen),pred = neck, modx = abdomen)
```


```{r}
aov(bodyfat_brozek ~ (age + height + neck + abdomen + forearm + wrist)^2,data = df_body_fat) %>% summary

aov(update(stepwise.fit, . ~ . + neck*abdomen)) %>% summary
```

```{r}
update(stepwise.fit, . ~ . + bicep) %>% summary
```

